{% import 'widgets/buttons.html.twig' as buttons %}

<div class="row">
    <div class="ui idea fluid card">
        <div class="content">
            <!-- vote box -->
            <div class="ui vote basic compact floated left segment center aligned">
                <div class="ui top attached {{ idea.relativeState }} basic label">{{ idea.relativeState | trans | upper }}</div>
                <div class="ui tiny statistic">
                    <div class="value">{{ idea.votes | length }}</div>
                    <div class="label">votos</div>
                </div>
                {% if idea.closed %}
                    {{ buttons.simple_label('closed', 'red') }}
                {% elseif not is_granted('IS_AUTHENTICATED_FULLY') %}
                    {{ buttons.animated_button(null, 'plus', 'connect', null, path('login')) }}
                {% elseif is_granted('OWNER', idea) %}
                    {{ buttons.simple_button('edit', path('idea_edit', {slug: idea.slug}), 'green') }}
                {% elseif is_voted(idea) %}
                    {{ buttons.js_animated_button('joined', null, 'leave', null, idea.slug, 'green leave idea') }}
                {% elseif idea.numSeats > 0 and idea.votes.count >= idea.numSeats %}
                    {{ buttons.simple_label('full', 'red') }}
                {% else %}
                    {{ buttons.js_animated_button(null, 'plus', 'join', null, idea.slug, 'join idea') }}
                {% endif %}
            </div>
            <!-- end vote box -->

            <!-- vote body -->
            <div class="meta send by">
                <span class="group">{{ idea.group }}</span> {{ 'send_by' | trans({'%owner%': idea.owner.username, '%when%': idea.createdAt | time_diff}) }}
            </div>
            <a class="header" href="{{ path('idea_show', {'slug': idea.slug}) }}">{{ idea.title }}</a>

            {% if complete is defined %}
                <div class="description">{{ idea.description | purify }}</div>
            {% else %}
                <div class="description">
                    <div class="summary">{{ idea.description | purify('summary') }}</div>
                </div>
            {% endif %}
            <!-- end vote body -->
        </div>
        <div class="extra content">
            <a href="{{ path('idea_show', {slug: idea.slug}) }}#comments">
                <i class="comment icon"></i>
                {{ idea_count_comments(idea) }}
            </a>
            &nbsp;
            {% if idea.numSeats > 0 %}
                <span>
                    <i class="add user icon"></i>
                    {{ 'idea_num_seats' | transchoice(idea.numSeats, {'%count%': idea.numSeats}) }}
                </span>
            {% endif %}
        </div>

        {% if is_granted('ROLE_ADMIN') %}
            <div class="extra content">
                <div class="row">
                    <div class="column">
                        <h4 class="ui dividing header">Administrar</h4>

                        <div class="ui buttons">
                            {% if idea.closed %}
                                {{ buttons.js_icon_button('open_idea', 'unlock', idea.slug, 'open idea') }}
                            {% else %}
                                {{ buttons.js_icon_button('close_idea', 'lock', idea.slug, 'close idea') }}
                            {% endif %}
                            {% if idea.state != constant('App\\Entity\\Idea::STATE_APPROVED') %}
                                {{ buttons.js_icon_button('approve_idea', 'thumbs up outline', idea.slug, 'approve idea') }}
                            {% endif %}
                            {% if idea.state != constant('App\\Entity\\Idea::STATE_REJECTED') %}
                                {{ buttons.js_icon_button('reject_idea', 'thumbs down outline', idea.slug, 'reject idea') }}
                            {% endif %}
                            {{ buttons.icon_button('edit_idea', 'pencil', path('admin_app_idea_edit', {id: idea.id})) }}
                            {{ buttons.icon_button('idea_send_message', 'mail', path('idea_send_message', {slug: idea.slug})) }}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        {% if complete is defined %}
            <div class="extra content">
                <div class="row">
                    <div class="column">
                        <h3 class="ui dividing header">Participantes</h3>

                        {% for vote in idea.votes %}
                            {% set user = vote.user %}
                            <a class="ui basic image label"
                                {% if is_granted('ROLE_ADMIN') %}
                                    href="{{ path('admin_app_user_show', {'id': user.id}) }}"
                                    data-tooltip="{{ user.fullname }}"
                                {% endif %}
                            >
                                {% if user.image.name is not empty %}
                                    <img src="{{ vich_uploader_asset(user, 'imageFile') | imagine_filter('squared_thumbnail') }}">
                                {% else %}
                                    <img src="{{ asset('assets/images/default.png') }}">
                                {% endif %}
                                {% if is_granted('ROLE_ADMIN') %}
                                {{ user.username }}
                                {% else %}
                                {{ user.alias }}
                                {% endif %}
                            </a>
                        {% else %}
                            <span class="ui label">No hay participantes</span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="extra content">
                <div class="row">
                    <div class="column">
                        <h3 class="ui dividing header">Comentarios</h3>
                    </div>

                    {% if is_granted('IS_AUTHENTICATED_FULLY') %}
                        {% include '@FOSComment/Thread/async.html.twig' with {'id': idea.id} %}
                    {% else %}
                        <div class="ui icon message">
                            <i class="add user icon"></i>
                            <div class="content">
                                <div class="header">
                                    ¿Quieres participar?
                                </div>
                                <p>
                                    <a href="{{ path('login') }}">Inicia sesión</a> para dejar un comentario.
                                </p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
